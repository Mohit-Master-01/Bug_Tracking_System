@model Bug_Tracking_System.DTOs.DashboardDTO


@{
    ViewData["Title"] = "Dashboard";
    var role = Model.Role;
    var hasProject = Model.TotalBugsInCurrentProject > 0; // Check if project is selected and has data

}

<!-- Argon Dashboard Layout Container -->
<div class="container-fluid py-4">

    <!-- ======= Admin Dashboard ======= -->
    @if (role == 4)
    {
        <div class="row">
            <!-- Card 1 -->
            <div class="col-xl-4 col-md-6 mb-4">
                <div class="card">
                    <div class="card-body p-3">
                        <div class="row">
                            <div class="col-8">
                                <div class="numbers">
                                    <p class="text-sm mb-0 text-uppercase font-weight-bold">Total Users</p>
                                    <h5 class="font-weight-bolder">@Model.TotalUsers</h5>
                                </div>
                            </div>
                            <div class="col-4 text-end">
                                <div class="icon icon-shape bg-gradient-primary shadow text-center rounded-circle">
                                    <i class="fas fa-users text-lg opacity-10" aria-hidden="true"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Card 2 -->
            <div class="col-xl-4 col-md-6 mb-4">
                <div class="card">
                    <div class="card-body p-3">
                        <div class="row">
                            <div class="col-8">
                                <div class="numbers">
                                    <p class="text-sm mb-0 text-uppercase font-weight-bold">Project Managers</p>
                                    <h5 class="font-weight-bolder">@Model.TotalProjectManagers</h5>
                                </div>
                            </div>
                            <div class="col-4 text-end">
                                <div class="icon icon-shape bg-gradient-info shadow text-center rounded-circle">
                                    <i class="fas fa-user-tie text-lg opacity-10" aria-hidden="true"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Card 3 -->
            <div class="col-xl-4 col-md-6 mb-4">
                <div class="card">
                    <div class="card-body p-3">
                        <div class="row">
                            <div class="col-8">
                                <div class="numbers">
                                    <p class="text-sm mb-0 text-uppercase font-weight-bold">Developers</p>
                                    <h5 class="font-weight-bolder">@Model.TotalDevelopers</h5>
                                </div>
                            </div>
                            <div class="col-4 text-end">
                                <div class="icon icon-shape bg-gradient-success shadow text-center rounded-circle">
                                    <i class="fas fa-code text-lg opacity-10" aria-hidden="true"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Card 4 -->
            <div class="col-xl-4 col-md-6 mb-4">
                <div class="card">
                    <div class="card-body p-3">
                        <div class="row">
                            <div class="col-8">
                                <div class="numbers">
                                    <p class="text-sm mb-0 text-uppercase font-weight-bold">Testers</p>
                                    <h5 class="font-weight-bolder">@Model.TotalTesters</h5>
                                </div>
                            </div>
                            <div class="col-4 text-end">
                                <div class="icon icon-shape bg-gradient-danger shadow text-center rounded-circle">
                                    <i class="fas fa-bug text-lg opacity-10" aria-hidden="true"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Card 5 -->
            <div class="col-xl-4 col-md-6 mb-4">
                <div class="card">
                    <div class="card-body p-3">
                        <div class="row">
                            <div class="col-8">
                                <div class="numbers">
                                    <p class="text-sm mb-0 text-uppercase font-weight-bold">Total Projects</p>
                                    <h5 class="font-weight-bolder">@Model.TotalProjects</h5>
                                </div>
                            </div>
                            <div class="col-4 text-end">
                                <div class="icon icon-shape bg-gradient-warning shadow text-center rounded-circle">
                                    <i class="fas fa-project-diagram text-lg opacity-10" aria-hidden="true"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Card 6 -->
            <div class="col-xl-4 col-md-6 mb-4">
                <div class="card">
                    <div class="card-body p-3">
                        <div class="row">
                            <div class="col-8">
                                <div class="numbers">
                                    <p class="text-sm mb-0 text-uppercase font-weight-bold">Total Bugs</p>
                                    <h5 class="font-weight-bolder">@Model.TotalBugs</h5>
                                </div>
                            </div>
                            <div class="col-4 text-end">
                                <div class="icon icon-shape bg-gradient-secondary shadow text-center rounded-circle">
                                    <i class="fas fa-bug-slash text-lg opacity-10" aria-hidden="true"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>


        <div class="row">
            <div class="col-md-6 col-lg-6">
                <div class="card">
                    <div class="card-header border-0">
                        <h3 class="mb-0">Users by Role</h3>
                    </div>
                    <div class="card-body">
                        <canvas id="usersByRoleChart" height="300"></canvas>
                    </div>
                </div>
            </div>
            <div class="col-md-6 col-lg-6">
                <div class="card">
                    <div class="card-header border-0">
                        <h3 class="mb-0">Bugs by Status</h3>
                    </div>
                    <div class="card-body">
                        <canvas id="bugsByStatusChart" height="300"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <div class="row">
            <div class="col-md-6 col-lg-6">
                <div class="card">
                    <div class="card-header border-0">
                        <h3 class="mb-0">Bugs by Severity</h3>
                    </div>
                    <div class="card-body">
                        <canvas id="bugsBySeverityChart" height="300"></canvas>
                    </div>
                </div>
            </div>
            <div class="col-md-6 col-lg-6">
                <div class="card h-100">
                    <div class="card-header border-0">
                        <h3 class="mb-0">Bugs Over Time</h3>
                    </div>
                    <div class="card-body d-flex align-items-center" style="height: 300px;">
                        <div style="overflow-x: auto; width: 100%;">
                            <canvas id="bugsOverTimeChart" style="min-width: 700px; height: 100%;"></canvas>
                        </div>
                    </div>
                </div>
            </div>

        </div>
    }

    <!-- ======= Project Manager Dashboard ======= -->
    @if (role == 1)
    {
        <div class="row">
            <!-- My Projects -->
            <div class="col-xl-4 col-md-6 mb-4">
                <div class="card">
                    <div class="card-body p-3">
                        <div class="row">
                            <div class="col-8">
                                <p class="text-sm mb-0 text-uppercase font-weight-bold">My Projects</p>
                                <h5 class="font-weight-bolder">@Model.MyProjects</h5>
                            </div>
                            <div class="col-4 text-end">
                                <div class="icon icon-shape bg-gradient-warning shadow text-center rounded-circle">
                                    <i class="fas fa-folder-open text-lg opacity-10"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Bugs in My Projects -->
            <div class="col-xl-4 col-md-6 mb-4">
                <div class="card">
                    <div class="card-body p-3">
                        <div class="row">
                            <div class="col-8">
                                <p class="text-sm mb-0 text-uppercase font-weight-bold">Bugs in My Projects</p>
                                <h5 class="font-weight-bolder">@Model.BugsInMyProjects</h5>
                            </div>
                            <div class="col-4 text-end">
                                <div class="icon icon-shape bg-gradient-danger shadow text-center rounded-circle">
                                    <i class="fas fa-bug text-lg opacity-10"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Total Testers -->
            <div class="col-xl-4 col-md-6 mb-4">
                <div class="card">
                    <div class="card-body p-3">
                        <div class="row">
                            <div class="col-8">
                                <div class="numbers">
                                    <p class="text-sm mb-0 text-uppercase font-weight-bold">Testers</p>
                                    <h5 class="font-weight-bolder">@Model.TotalTesters</h5>
                                </div>
                            </div>
                            <div class="col-4 text-end">
                                <div class="icon icon-shape bg-gradient-info shadow text-center rounded-circle">
                                    <i class="fas fa-users text-lg opacity-10" aria-hidden="true"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            @if (hasProject)
            {
                <!-- Developers in Project -->
                <div class="col-xl-4 col-md-6 mb-4">
                    <div class="card">
                        <div class="card-body p-3">
                            <div class="row">
                                <div class="col-8">
                                    <div class="numbers">
                                        <p class="text-sm mb-0 text-uppercase font-weight-bold">Developers in Project</p>
                                        <h5 class="font-weight-bolder">@Model.DevelopersInCurrentProject</h5>
                                    </div>
                                </div>
                                <div class="col-4 text-end">
                                    <div class="icon icon-shape bg-gradient-success shadow text-center rounded-circle">
                                        <i class="fas fa-user-cog text-lg opacity-10" aria-hidden="true"></i>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            }
        </div>

      


        <!-- Graphs -->
        @if (hasProject)
        {
            <!-- Charts Section -->
            <div class="row mt-4">
                <div class="col-md-6">
                    <div class="card shadow">
                        <div class="card-header border-0">
                            <h3 class="mb-0">Bugs by Status</h3>
                        </div>
                        <div class="card-body">
                            <canvas id="bugsByStatusChart" style="width:100%; height:250px;"></canvas>
                        </div>
                    </div>
                </div>

                <div class="col-md-6">
                    <div class="card shadow">
                        <div class="card-header border-0">
                            <h3 class="mb-0">Bugs by Severity</h3>
                        </div>
                        <div class="card-body">
                            <canvas id="bugsBySeverityChart" style="width:100%; height:250px;"></canvas>
                        </div>
                    </div>
                </div>
            </div>


            <div class="row mt-4">
                <div class="col-md-12">
                    <div class="card shadow">
                        <div class="card-header border-0">
                            <h3 class="mb-0">Bug Activity Timeline</h3>
                        </div>
                        <div class="card-body">
                            <canvas id="bugTimelineChart" style="width:100%; height:300px;"></canvas>
                        </div>
                    </div>
                </div>
            </div>


            <div class="row mt-4 mb-4">
                <div class="col-md-12">
                    <div class="card shadow">
                        <div class="card-body">
                            <h4>Project Progress</h4>
                            <div class="progress" style="height:25px; background-color:#f0f0f0;">
                                <div class="progress-bar bg-gradient-success"
                                     role="progressbar"
                                     style="width:@Model.ProjectProgress%; font-weight:bold; font-size:14px; line-height:25px;"
                                     aria-valuenow="@Model.ProjectProgress" aria-valuemin="0" aria-valuemax="100">
                                    @Model.ProjectProgress%
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

        }
    }


</div>



<!-- Chart Libraries -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

@using System.Text.Json

@section Scripts {
    @if (role == 4)
    {

        <script>
            const usersByRoleCtx = document.getElementById('usersByRoleChart');
            const bugsByStatusCtx = document.getElementById('bugsByStatusChart');
            const bugsBySeverityCtx = document.getElementById('bugsBySeverityChart');
            const bugsOverTimeCtx = document.getElementById('bugsOverTimeChart');

            new Chart(usersByRoleCtx, {
            type: 'pie',
            data: {
            labels: @Html.Raw(JsonSerializer.Serialize(Model.UsersByRole.Keys)),
            datasets: [{
            data: @Html.Raw(JsonSerializer.Serialize(Model.UsersByRole.Values)),
            backgroundColor: ['#5e72e4', '#11cdef', '#f5365c', '#fb6340']
            }]
            },
            options: { responsive: true, maintainAspectRatio: false }
            });

            new Chart(bugsByStatusCtx, {
            type: 'bar',
            data: {
            labels: @Html.Raw(JsonSerializer.Serialize(Model.BugsByStatus.Keys)),
            datasets: [{
            label: 'Bugs',
            data: @Html.Raw(JsonSerializer.Serialize(Model.BugsByStatus.Values)),
            backgroundColor: ['#f5365c', '#11cdef', '#2dce89', '#fb6340']
            }]
            },
            options: {
            responsive: true, maintainAspectRatio: false,
            scales: { y: { beginAtZero: true } }
            }
            });

            new Chart(bugsBySeverityCtx, {
            type: 'doughnut',
            data: {
            labels: @Html.Raw(JsonSerializer.Serialize(Model.BugsBySeverity.Keys)),
            datasets: [{
            data: @Html.Raw(JsonSerializer.Serialize(Model.BugsBySeverity.Values)),
            backgroundColor: ['#2dce89', '#11cdef', '#fb6340']
            }]
            },
            options: { responsive: true, maintainAspectRatio: false }
            });

            new Chart(bugsOverTimeCtx, {
            type: 'line',
            data: {
            labels: @Html.Raw(JsonSerializer.Serialize(Model.BugsOverTime.Keys)),
            datasets: [{
            label: 'Bugs Over Time',
            data: @Html.Raw(JsonSerializer.Serialize(Model.BugsOverTime.Values)),
            fill: false,
            borderColor: '#5e72e4',
            tension: 0.1
            }]
            },
            options: { responsive: true, maintainAspectRatio: false }
            });
        </script>
    }

    @if (role == 1)
    {
        <script>
            const bugsByStatusData = @Html.Raw(JsonSerializer.Serialize(Model.MyBugsByStatus));
                const bugsBySeverityData = @Html.Raw(JsonSerializer.Serialize(Model.MyBugsBySeverity));
                const bugTimelineData = @Html.Raw(JsonSerializer.Serialize(Model.BugActivityTimeline));

            // Bugs by Status Chart
            const statusCtx = document.getElementById('bugsByStatusChart');
            new Chart(statusCtx, {
                type: 'pie',
                data: {
                    labels: Object.keys(bugsByStatusData),
                    datasets: [{
                        data: Object.values(bugsByStatusData),
                        backgroundColor: ['#f5365c', '#5e72e4', '#2dce89', '#fb6340']
                    }]
                }
            });

            // Bugs by Severity Chart
            const severityCtx = document.getElementById('bugsBySeverityChart');
            new Chart(severityCtx, {
                type: 'doughnut',
                data: {
                    labels: Object.keys(bugsBySeverityData),
                    datasets: [{
                        data: Object.values(bugsBySeverityData),
                        backgroundColor: ['#11cdef', '#2dce89', '#f5365c', '#fb6340']
                    }]
                }
            });

            // Bug Activity Timeline Chart
            const timelineCtx = document.getElementById('bugTimelineChart');
            new Chart(timelineCtx, {
                type: 'line',
                data: {
                    labels: Object.keys(bugTimelineData),
                    datasets: [{
                        label: 'Bugs Created',
                        data: Object.values(bugTimelineData),
                        fill: false,
                        borderColor: '#5e72e4',
                        tension: 0.3
                    }]
                }
            });
        </script>

    }
}
